#!/bin/sh

export PGHOST=$PWD/.postgres
export PGDATA=$PGHOST/data
export PGDATABASE=postgres
export PGLOG=$PGHOST/postgres.log

mkdir -p $PGHOST

if [ ! -d $PGDATA ]; then
  initdb --auth=trust --no-locale --encoding=UTF8
fi

if ! pg_ctl status > /dev/null
then
  pg_ctl start -l $PGLOG -o "--unix_socket_directories='$PGHOST'"

  echo "creating database"
  psql --command 'create database tagger'

  echo "creating user"
  psql --command 'create user tagger;'

  echo "granting privileges"
  psql --command 'grant all privileges on database tagger to tagger;'

  echo "settings schema"
  psql -U tagger -d tagger -f ./schema.sql;
fi
